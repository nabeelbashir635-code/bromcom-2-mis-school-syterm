name: Deploy site

on:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Debug: show workspace
        run: |
          echo "--- Workspace info ---"
          echo "PWD: $(pwd)"
          echo "Listing top-level files:"
          ls -la
          echo "Disk usage of repo:" && du -sh . || true
          echo "Git branch and commit:"
          git rev-parse --abbrev-ref HEAD || true
          git rev-parse HEAD || true
          echo "Selected env vars:"
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_REF=$GITHUB_REF"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "RUNNER_WORKSPACE=$RUNNER_WORKSPACE"
          echo "RUNNER_TEMP=$RUNNER_TEMP"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Configure Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: .

      - id: deploy_pages
        name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v1

      - name: Deploy to Netlify (optional)
        if: ${{ secrets.NETLIFY_AUTH_TOKEN != '' }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          set -euo pipefail
          echo "Preparing Netlify deploy..."
          if [ -z "${NETLIFY_SITE_ID:-}" ]; then
            echo "No NETLIFY_SITE_ID provided; creating new Netlify site..."
            resp=$(curl -s -X POST "https://api.netlify.com/api/v1/sites" -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" -H "Content-Type: application/json" -d '{}')
            SITE_ID=$(echo "$resp" | python3 -c "import sys,json; obj=json.load(sys.stdin); print(obj.get('id',''))")
            if [ -z "${SITE_ID}" ]; then echo "Failed to create Netlify site: $resp"; exit 1; fi
            echo "Created Netlify site: $SITE_ID"
          else
            SITE_ID=${NETLIFY_SITE_ID}
            echo "Using provided NETLIFY_SITE_ID: $SITE_ID"
          fi
          npm install -g netlify-cli
          netlify deploy --prod --dir=. --site=${SITE_ID} --auth=${NETLIFY_AUTH_TOKEN}
          echo "NETLIFY_SITE_ID=${SITE_ID}" >> "$GITHUB_ENV"

      - name: Post-deploy health check
        env:
          PAGES_URL: ${{ steps.deploy_pages.outputs.page_url }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ env.NETLIFY_SITE_ID }}
        run: |
          set -euo pipefail
          PAGES_URL=${PAGES_URL:-}
          if [ -z "$PAGES_URL" ]; then
            OWNER=${GITHUB_REPOSITORY%%/*}
            REPO=${GITHUB_REPOSITORY#*/}
            PAGES_URL="https://${OWNER}.github.io/${REPO}/"
            echo "Fallback Pages URL: $PAGES_URL"
          else
            echo "Pages URL: $PAGES_URL"
          fi

          check_url(){
            url=$1
            tries=0
            until [ $tries -ge 6 ]; do
              status=$(curl -s -o /dev/null -w "%{http_code}" "$url" || echo "000")
              if [ "$status" -ge 200 ] && [ "$status" -lt 400 ]; then
                echo "$url is healthy (HTTP $status)"
                return 0
              fi
              tries=$((tries+1))
              echo "Attempt $tries failed (HTTP $status). Retrying in 5s..."
              sleep 5
            done
            echo "$url did not respond successfully after retries (last HTTP $status)"
            return 1
          }

          if ! check_url "$PAGES_URL"; then
            echo "GitHub Pages health check failed." >&2
            exit 1
          fi

          if [ -n "${NETLIFY_SITE_ID:-}" ] && [ -n "${NETLIFY_AUTH_TOKEN:-}" ]; then
            info=$(curl -s -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}")
            site_url=$(echo "$info" | python3 -c "import sys,json; obj=json.load(sys.stdin); print(obj.get('ssl_url') or obj.get('url') or '')")
            if [ -n "$site_url" ]; then
              echo "Netlify site URL: $site_url"
              if ! check_url "$site_url"; then
                echo "Netlify health check failed." >&2
                exit 1
              fi
            else
              echo "Unable to determine Netlify site URL. Info: $info"
            fi
          fi
